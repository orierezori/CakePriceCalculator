<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cake Price Calculator</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      margin: 0;
      background-color: #FFF7E0;
      max-width: 600px;
      margin: 0 auto;
      color: #8B4050;
    }
    h1 {
      text-align: center;
      color: #8B4050;
      font-size: 2rem;
      margin: 1.5rem 0;
      text-shadow: 1px 1px 2px rgba(213, 196, 140, 0.3);
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: #F7D7E3;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(139, 64, 80, 0.1);
    }
    label {
      font-weight: 600;
      color: #8B4050;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #E9E3F9;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      color: #8B4050;
    }
    input[type="checkbox"] {
      width: 1.2rem;
      height: 1.2rem;
      margin: 0;
      accent-color: #FFD8B1;
    }
    label:has(> input[type="checkbox"]) {
      flex-direction: row;
      align-items: center;
      gap: 0.8rem;
    }
    .hidden { display: none; }
    select[multiple] {
      height: auto;
      min-height: 8rem;
      padding: 0;
    }
    select[multiple] option {
      padding: 0.8rem;
      border-bottom: 1px solid #E9E3F9;
    }
    option:checked {
      background-color: #FFD8B1;
      color: #8B4050;
    }
    h2 {
      text-align: center;
      color: #8B4050;
      margin-top: 2rem;
      padding: 1.2rem;
      background: #E9E3F9;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(139, 64, 80, 0.1);
    }

    .summary-order-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: #F7D7E3;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(139, 64, 80, 0.1);
      margin-top: 2rem;
    }

    .summary-order-section h2 {
      text-align: center;
      color: #8B4050;
      font-size: 1.5rem;
      margin: 0 0 1rem 0;
      text-shadow: 1px 1px 2px rgba(213, 196, 140, 0.3);
      background: none;
      box-shadow: none;
      padding: 0;
    }

    input[type="date"] {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #E9E3F9;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      color: #8B4050;
      font-family: Arial, sans-serif;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
        opacity: 0.6;
    }
    input[type="date"]:required:invalid::-webkit-datetime-edit {
        color: #999;
    }

    #summariseOrderBtn {
      background-color: #8B4050;
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
      width: 100%;
      transition: background-color 0.3s ease;
    }

    #summariseOrderBtn:hover {
      background-color: #A45069;
    }

    #orderSummaryOutputContainer {
        margin-top: 1.5rem;
        background: #E9E3F9;
        padding: 1rem;
        border-radius: 8px;
    }

    #orderSummaryOutput {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: Arial, sans-serif;
        color: #8B4050;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 1rem;
    }

    .topper-text-input {
      margin-left: 0.5rem;
      flex-grow: 1;
      min-width: 100px;
      width: auto;
    }

    #summaryActionsContainer {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-top: 1rem;
    }

    #copySummaryBtn,
    #generateTikkieBtn {
      background-color: #8B4050;
      color: white;
      padding: 0.5rem 0.8rem;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #copySummaryBtn:hover,
    #generateTikkieBtn:hover {
      background-color: #A45069;
    }

    #copySummaryBtn .icon {
        margin-right: 0.3em;
    }

    /* --- CSS for Summarize Buttons --- */
    #summarizeButtonsContainer {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem; /* Matches original button margin-top */
    }

    .summary-action-btn {
      background-color: #8B4050;
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      flex: 1; /* Make buttons share the space */
    }

    .summary-action-btn:hover {
      background-color: #A45069;
    }
    .summary-action-btn:disabled {
      background-color: #A45069; /* Slightly different shade for disabled */
      cursor: not-allowed;
    }
    /* --- End of CSS for Summarize Buttons --- */

    /* --- ADDED CSS for Tikkie placeholder --- */
    .tikkie-placeholder {
        color: #0066cc; /* A distinct link-like color */
        text-decoration: underline;
        cursor: pointer;
    }
    .tikkie-placeholder:hover {
        color: #004C99; /* Darker on hover */
    }
    /* --- END OF ADDED CSS --- */

  </style>
</head>
<body>
  <h1>Cake Price Calculator</h1>
  <form id="cakeForm">
    <label>Type
      <select id="type">
        <option value="cake">Cake</option>
        <option value="cupcake">Cupcake</option>
      </select>
    </label>
    <label>Amount
      <input type="number" id="amount" min="1" max="500" value="1">
    </label>
    <label id="cakeStyleLabel">Cake Style
      <select id="cakeStyle">
        <option value="classic">Classic</option>
        <option value="custom">Custom Made</option>
      </select>
    </label>
    <label>Taste of Cake
      <select id="taste">
        <option value="vanilla">Vanilla</option>
        <option value="chocolate">Chocolate</option>
        <option value="carrot">Carrot</option>
        <option value="orange">Orange</option>
      </select>
    </label>
    <label>Size
      <select id="size">
        <option value="18">18''</option>
        <option value="20">20''</option>
        <option value="mini">Mini</option>
        <option value="regular">Regular</option>
      </select>
    </label>
    <label id="creamToppingLabel">Cream Topping
      <input type="checkbox" id="creamTopping">
    </label>
    <label id="layersLabel">Layers
      <select id="layers">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>
    </label>
    <label>Natural Colors
      <input type="checkbox" id="naturalColors">
    </label>
    <label id="sprinklesLabel">Sprinkles
      <input type="checkbox" id="sprinkles">
    </label>
    <label id="pipingLabel">Piping
      <input type="checkbox" id="piping">
    </label>
    <label id="lettersLabel">Letters on Cake
      <select id="letters">
        <option value="no">No</option>
        <option value="small">Small</option>
        <option value="big">Big</option>
      </select>
    </label>
    <label id="nameLabel">Name on Cake
      <input type="text" id="cakeName">
    </label>
    <label id="nutsLabel">Nuts
      <input type="checkbox" id="nuts">
    </label>
    <label id="fruitsLabel">Fruits
      <input type="checkbox" id="fruits">
    </label>
    <label id="layerFillingLabel">Layer Filling
      <select id="layerFilling" size="5" multiple>
        <option value="nuts">Nuts</option>
        <option value="fruits">Fruits</option>
        <option value="oreo">Oreo</option>
        <option value="lotus">Lotus</option>
        <option value="jam">Jam</option>
      </select>
    </label>
    <label id="toppers1Label">Toppers 1
      <input type="checkbox" id="topper1">
      <input type="text" id="topper1Text" placeholder="Optional details" class="topper-text-input hidden">
    </label>
    <label id="toppers2Label">Toppers 2
      <input type="checkbox" id="topper2">
      <input type="text" id="topper2Text" placeholder="Optional details" class="topper-text-input hidden">
    </label>
  </form>
  <h2>Total Price: ‚Ç¨<span id="totalPrice">0.00</span></h2>

  <div class="summary-order-section">
    <h2>Order Details</h2>
    <label>Theme
      <input type="text" id="theme" name="theme" placeholder="e.g., Unicorn, Floral, Spiderman">
    </label>
    <label>Pickup Date
      <input type="date" id="pickupDate" name="pickupDate">
    </label>
    <label>Allergies / Special Requests
      <input type="text" id="alergies" name="alergies" placeholder="e.g., Gluten-free, nut allergy, less sugar">
    </label>
    <div id="summarizeButtonsContainer">
        <button type="button" id="summariseOrderBtn" class="summary-action-btn">Summarise Order</button>
        <button type="button" id="summariseOrderAIBtn" class="summary-action-btn">Summarise Order AI</button>
    </div>
    <div id="orderSummaryOutputContainer" style="display: none;">
      <pre id="orderSummaryOutput"></pre>
      <div id="summaryActionsContainer">
        <button id="copySummaryBtn" title="Copy Summary"><span class="icon">üìã</span> Copy</button>
        <button id="generateTikkieBtn">Generate Tikkie</button>
      </div>
    </div>
    <div></div>
  </div>

  <script>
    const form = document.getElementById('cakeForm');
    const totalPriceEl = document.getElementById('totalPrice');

    function calculatePrice() {
      const type = document.getElementById('type').value;
      const amount = parseInt(document.getElementById('amount').value);
      const cakeStyle = document.getElementById('cakeStyle').value;
      const size = document.getElementById('size').value;
      const creamTopping = document.getElementById('creamTopping').checked;
      const layers = parseInt(document.getElementById('layers').value);
      const naturalColors = document.getElementById('naturalColors').checked;
      const sprinkles = document.getElementById('sprinkles').checked;
      const piping = document.getElementById('piping').checked;
      const letters = document.getElementById('letters').value;
      const cakeName = document.getElementById('cakeName').value || "";
      const nuts = document.getElementById('nuts').checked;
      const fruits = document.getElementById('fruits').checked;
      const layerFilling = [...document.getElementById('layerFilling').options].filter(o => o.selected).map(o => o.value);
      const topper1 = document.getElementById('topper1').checked;
      const topper2 = document.getElementById('topper2').checked;

      let price = 0;

      if (type === 'cake') {
        price += size === '18' ? 30 : 35;
        price += (layers - 1) * 10;
        if (naturalColors) price += 2;
        if (sprinkles) price += 3;
        if (piping) price += cakeStyle === 'classic' ? 7 : 15;
        if (letters !== 'no') price += (letters === 'small' ? 0.2 : 0.5) * cakeName.length;
        if (nuts) price += 5;
        if (fruits) price += 5;
        if (layers > 1 && layerFilling.length > 0) {
          const totalFilling = layerFilling.reduce((sum, fill) => sum + (fill === 'jam' ? 1 : 1.5), 0);
          price += (layers - 1) * totalFilling;
        }
        if (topper1) price += 10;
        if (topper2) price += 10;
      } else {
        price += size === 'mini' ? 2 * amount : 4 * amount;
        if (creamTopping) price += 0.5 * amount;
        if (naturalColors) {
          if (amount <= 12) price += 1;
          else if (amount <= 30) price += 2;
          else price += 2 + Math.ceil((amount - 30) / 20) * 2;
        }
      }
      totalPriceEl.textContent = price.toFixed(2);
    }

    function updateVisibility() {
      const typeSelect = document.getElementById('type');
      const prevType = typeSelect.dataset.prevType || '';
      const currentType = typeSelect.value;

      const topper1Checkbox = document.getElementById('topper1');
      const topper1TextInput = document.getElementById('topper1Text');
      const topper2Checkbox = document.getElementById('topper2');
      const topper2TextInput = document.getElementById('topper2Text');

      if (prevType && prevType !== currentType) {
        form.reset();
        document.getElementById('theme').value = '';
        document.getElementById('pickupDate').value = '';
        document.getElementById('alergies').value = '';
        topper1TextInput.value = '';
        topper2TextInput.value = '';

        document.getElementById('type').value = currentType;
        document.getElementById('amount').value = 1;
        if (document.getElementById('orderSummaryOutputContainer')) {
            document.getElementById('orderSummaryOutputContainer').style.display = 'none';
        }
      }

      typeSelect.dataset.prevType = currentType;

      const type = currentType;
      const layers = parseInt(document.getElementById('layers').value);
      const letters = document.getElementById('letters').value;

      const cakeOnly = ["cakeStyleLabel", "layersLabel", "sprinklesLabel", "pipingLabel", "lettersLabel", "nameLabel", "nutsLabel", "fruitsLabel", "toppers1Label", "toppers2Label"];
      const cupcakeOnly = ["creamToppingLabel"];

      cakeOnly.forEach(id => document.getElementById(id).classList.toggle('hidden', type !== 'cake'));
      cupcakeOnly.forEach(id => document.getElementById(id).classList.toggle('hidden', type !== 'cupcake'));

      document.getElementById('layerFillingLabel').classList.toggle('hidden', type !== 'cake' || layers === 1);

      const nameLabel = document.getElementById('nameLabel');
      const cakeNameInput = document.getElementById('cakeName');
      const hideName = type !== 'cake' || letters === 'no';
      nameLabel.classList.toggle('hidden', hideName);
      if (hideName) cakeNameInput.value = '';

      const taste = document.getElementById('taste');
      const size = document.getElementById('size');
      Array.from(taste.options).forEach(opt => {
        if (type === 'cake' && (opt.value === 'carrot' || opt.value === 'orange')) opt.disabled = true;
        else if (type === 'cupcake') opt.disabled = false;
      });

      const validSizes = type === 'cake' ? ['18', '20'] : ['mini', 'regular'];
      Array.from(size.options).forEach(opt => {
        const isValid = validSizes.includes(opt.value);
        opt.hidden = !isValid;
        opt.disabled = !isValid;
      });

      if (!validSizes.includes(size.value)) {
        size.value = validSizes[0];
      }

      const isCakeType = type === 'cake';
      topper1TextInput.classList.toggle('hidden', !topper1Checkbox.checked || !isCakeType);
      topper2TextInput.classList.toggle('hidden', !topper2Checkbox.checked || !isCakeType);

      if (!topper1Checkbox.checked || !isCakeType) {
        topper1TextInput.value = '';
      }
      if (!topper2Checkbox.checked || !isCakeType) {
        topper2TextInput.value = '';
      }
    }

    form.addEventListener('change', () => {
      updateVisibility();
      calculatePrice();
    });

    updateVisibility();
    calculatePrice();

    const summariseOrderBtn = document.getElementById('summariseOrderBtn');
    const orderSummaryOutputContainer = document.getElementById('orderSummaryOutputContainer');
    const orderSummaryOutput = document.getElementById('orderSummaryOutput');

    summariseOrderBtn.addEventListener('click', () => {
      calculatePrice();

      const typeEl = document.getElementById('type');
      const typeValue = typeEl.value;
      const typeText = typeEl.options[typeEl.selectedIndex].text;

      const amount = parseInt(document.getElementById('amount').value);
      
      const cakeStyleEl = document.getElementById('cakeStyle');
      const cakeStyleText = cakeStyleEl.options[cakeStyleEl.selectedIndex].text;

      const tasteEl = document.getElementById('taste');
      const tasteText = tasteEl.options[tasteEl.selectedIndex].text;
      
      const sizeEl = document.getElementById('size');
      const sizeText = sizeEl.options[sizeEl.selectedIndex].text;

      const creamTopping = document.getElementById('creamTopping').checked;
      const layers = parseInt(document.getElementById('layers').value);
      const naturalColors = document.getElementById('naturalColors').checked;
      const sprinkles = document.getElementById('sprinkles').checked;
      const piping = document.getElementById('piping').checked;
      
      const lettersEl = document.getElementById('letters');
      const lettersValue = lettersEl.value;
      const lettersText = lettersEl.options[lettersEl.selectedIndex].text;
      
      const cakeName = document.getElementById('cakeName').value.trim();
      const nuts = document.getElementById('nuts').checked;
      const fruits = document.getElementById('fruits').checked;
      
      const layerFillingSelect = document.getElementById('layerFilling');
      const layerFillingTexts = [...layerFillingSelect.options]
                                .filter(o => o.selected)
                                .map(o => o.text);

      const topper1 = document.getElementById('topper1').checked;
      const topper2 = document.getElementById('topper2').checked;
      const topper1TextValue = document.getElementById('topper1Text').value.trim();
      const topper2TextValue = document.getElementById('topper2Text').value.trim();

      const theme = document.getElementById('theme').value.trim();
      const pickupDateValue = document.getElementById('pickupDate').value;
      const alergies = document.getElementById('alergies').value.trim();
      const totalPrice = document.getElementById('totalPrice').textContent;

      let summary = `Thanks so much for your interest in our custom ${typeValue === 'cake' ? 'üéÇ cake' : 'üßÅ cupcake'}! Based on your preferences, here's your order summary:\n\n`;
      summary += `üìù *Order Summary:*\n\n`;
      summary += `‚ú® *Type:* ${typeText}\n`;
      summary += `üî¢ *Amount:* ${amount}\n`;
      if (typeValue === 'cake') {
        summary += `üéÄ *Style:* ${cakeStyleText}\n`;
      }
      summary += `üç∞ *Flavor:* ${tasteText}\n`;

      if (typeValue === 'cake') {
        summary += `üìè *Size:* ${sizeText}\n`;
      } else {
        summary += `üßÅ *Cupcake Size:* ${sizeText}\n`;
      }

      if (theme) {
        summary += `üé® *Theme/Design:* ${theme}\n`;
      }
      
      if (typeValue === 'cake') {
        if (layers > 1) { 
            summary += `Í≤π *Layers:* ${layers}\n`;
        }
        if (naturalColors) {
          summary += `üåø *Natural Colors:* Yes\n`;
        }
        if (sprinkles) {
          summary += `‚ú® *Sprinkles:* Yes\n`;
        }
        if (piping) {
          summary += `üç• *Piping:* Yes\n`;
        }
        if (lettersValue !== 'no') {
          summary += `üî§ *Letters on Cake:* ${lettersText}\n`;
          if (cakeName) {
            summary += `üè∑Ô∏è *Name on Cake:* "${cakeName}"\n`;
          }
        }
        if (nuts) {
          summary += `ü•ú *Nuts (decoration):* Yes\n`;
        }
        if (fruits) {
          summary += `üçì *Fruits (decoration):* Yes\n`;
        }
        if (layerFillingTexts.length > 0 && layers > 1) {
          summary += `üç∞Í≤π *Layer Fillings:* ${layerFillingTexts.join(', ')}\n`;
        }
        if (topper1) {
          summary += `üéâ *Topper 1:* Yes`;
          if (topper1TextValue) {
            summary += ` (${topper1TextValue})`;
          }
          summary += `\n`;
        }
        if (topper2) {
          summary += `üéä *Topper 2:* Yes`;
          if (topper2TextValue) {
            summary += ` (${topper2TextValue})`;
          }
          summary += `\n`;
        }
      } else if (typeValue === 'cupcake') {
        if (creamTopping) {
          summary += `üç¶ *Cream Topping:* Yes\n`;
        }
        if (naturalColors) {
          summary += `üåø *Natural Colors:* Yes\n`;
        }
      }

      if (pickupDateValue) {
        const dateParts = pickupDateValue.split('-');
        const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
        summary += `üóìÔ∏è *Pickup Date:* ${formattedDate}\n`;
      } else {
        summary += `üóìÔ∏è *Pickup Date:* _Not specified_\n`;
      }
      
      if (alergies) {
        summary += `‚ö†Ô∏è *Allergies/Special Requests:* ${alergies}\n`;
      }

      summary += `\nüí∞ *Total Price:* ‚Ç¨${totalPrice}\n\n`;
      summary += `To confirm your order, please complete the payment via this Tikkie link:\n`;
      // --- MODIFIED: Wrap [Tikkie link] in a span ! ---
      summary += `üëâ <span class="tikkie-placeholder">[Tikkie link]</span>\n\n`;
      // --- END OF MODIFICATION ---
      summary += `Once the payment is done, your order will be officially confirmed. If you have any questions, I'm here for you! üí¨\n\n`;
      summary += `Looking forward to baking something special for you! üéÇüßÅ\n\n`;
      summary += `Maayan (Manu) ü©∑`;

      // --- MODIFIED: Use innerHTML to render the span ---
      orderSummaryOutput.innerHTML = summary;
      // --- END OF MODIFICATION ---
      orderSummaryOutputContainer.style.display = 'block';
    });

    const copySummaryBtn = document.getElementById('copySummaryBtn');
    const generateTikkieBtn = document.getElementById('generateTikkieBtn');

    copySummaryBtn.addEventListener('click', () => {
      const summaryText = orderSummaryOutput.textContent; // .textContent will get the text, including the updated Tikkie link
      if (navigator.clipboard && summaryText) {
        navigator.clipboard.writeText(summaryText)
          .then(() => {
            const originalText = copySummaryBtn.innerHTML;
            copySummaryBtn.innerHTML = 'Copied!';
            setTimeout(() => {
              copySummaryBtn.innerHTML = originalText;
            }, 2000);
          })
          .catch(err => {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy text. Please try manually.');
          });
      } else {
        alert('Clipboard API not available or no summary to copy.');
      }
    });

    generateTikkieBtn.addEventListener('click', () => {
      window.open('https://play.google.com/store/apps/details?id=com.abnamro.nl.tikkie&hl=en', '_blank');
    });

    // --- ADDED: Event listener for clickable Tikkie link placeholder ---
    orderSummaryOutput.addEventListener('click', function(event) {
        let targetElement = event.target;
        if (targetElement.classList.contains('tikkie-placeholder')) {
            event.preventDefault(); // Good practice for clickable spans
            
            const currentText = targetElement.textContent;
            const newLink = prompt("Please paste your Tikkie link here:", 
                                   (currentText !== '[Tikkie link]' && currentText.startsWith("http")) ? currentText : "https://");

            if (newLink !== null && newLink.trim() !== "" && newLink.trim() !== "https://") {
                targetElement.textContent = newLink.trim();
            } else if (newLink !== null && (newLink.trim() === "" || newLink.trim() === "https://")) { // User entered an empty string or just "https://"
                alert("No valid link was entered. The placeholder remains unchanged.");
                if (newLink.trim() === "") targetElement.textContent = '[Tikkie link]'; // Optionally revert if they clear it
            }
            // If newLink is null (user clicked cancel), do nothing.
        }
    });
    // --- END OF ADDED EVENT LISTENER ---

    // --- Event listener for Summarise Order AI button ---
    const summariseOrderAIBtn = document.getElementById('summariseOrderAIBtn');
    summariseOrderAIBtn.addEventListener('click', async () => {
      calculatePrice(); // Ensure price is current

      // Gather data for the prompt
      const typeEl = document.getElementById('type');
      const typeValue = typeEl.value;
      const amount = parseInt(document.getElementById('amount').value);
      const cakeStyleValue = document.getElementById('cakeStyle').value;
      const tasteValue = document.getElementById('taste').value;
      const sizeValue = document.getElementById('size').value;
      const creamTopping = document.getElementById('creamTopping').checked;
      const layers = parseInt(document.getElementById('layers').value);
      const naturalColors = document.getElementById('naturalColors').checked;
      const sprinkles = document.getElementById('sprinkles').checked;
      const piping = document.getElementById('piping').checked;
      const lettersValue = document.getElementById('letters').value;
      const cakeName = document.getElementById('cakeName').value.trim();
      const nuts = document.getElementById('nuts').checked;
      const fruits = document.getElementById('fruits').checked;
      const layerFillingSelect = document.getElementById('layerFilling');
      const layerFillingValues = [...layerFillingSelect.options]
                                .filter(o => o.selected)
                                .map(o => o.value);
      const topper1 = document.getElementById('topper1').checked;
      const topper1TextValue = document.getElementById('topper1Text').value.trim();
      const topper2 = document.getElementById('topper2').checked;
      const topper2TextValue = document.getElementById('topper2Text').value.trim();
      const theme = document.getElementById('theme').value.trim();
      const pickupDateValue = document.getElementById('pickupDate').value;
      const alergies = document.getElementById('alergies').value.trim();
      const totalPrice = document.getElementById('totalPrice').textContent;

      // Construct the prompt
      let promptString = `You are a helpful assistant specialized in summarizing cake orders for customers.

Based on the following information, generate a concise and friendly summary of the order.
Include all relevant details about the cake, such as type, amount, flavor, size, and decorations.
Also, include the pickup date, any allergies or special requests, and the total price.

Type: ${typeValue}
Amount: ${amount}
`;
      if (typeValue === 'cake') {
        promptString += `Cake Style: ${cakeStyleValue}\n`;
      }
      promptString += `Taste: ${tasteValue}\n`;
      promptString += `Size: ${sizeValue}\n`;

      if (typeValue === 'cupcake' && creamTopping) {
        promptString += `Cream Topping: Yes\n`;
      }
      if (typeValue === 'cake') { // Layers are always present for a cake, min 1
        promptString += `Layers: ${layers}\n`;
      }
      if (naturalColors) {
        promptString += `Natural Colors: Yes\n`;
      }
      if (typeValue === 'cake' && sprinkles) {
        promptString += `Sprinkles: Yes\n`;
      }
      if (typeValue === 'cake' && piping) {
        promptString += `Piping: Yes\n`;
      }
      if (typeValue === 'cake' && lettersValue && lettersValue !== 'no') {
        promptString += `Letters: ${lettersValue}\n`;
        if (cakeName) {
          promptString += `Cake Name: "${cakeName}"\n`;
        }
      }
      if (typeValue === 'cake' && nuts) {
        promptString += `Nuts (decoration): Yes\n`;
      }
      if (typeValue === 'cake' && fruits) {
        promptString += `Fruits (decoration): Yes\n`;
      }
      if (typeValue === 'cake' && layerFillingValues.length > 0 && layers > 1) {
        promptString += `Layer Fillings: ${layerFillingValues.join(', ')}\n`;
      }
      if (typeValue === 'cake' && topper1) {
        promptString += `Topper 1: Yes`;
        if (topper1TextValue) promptString += ` (${topper1TextValue})`;
        promptString += `\n`;
      }
      if (typeValue === 'cake' && topper2) {
        promptString += `Topper 2: Yes`;
        if (topper2TextValue) promptString += ` (${topper2TextValue})`;
        promptString += `\n`;
      }
      if (theme) {
        promptString += `Theme/Design: ${theme}\n`;
      }
      if (pickupDateValue) {
        const dateParts = pickupDateValue.split('-');
        const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
        promptString += `Pickup Date: ${formattedDate}\n`;
      }
      if (alergies) {
        promptString += `Allergies/Special Requests: ${alergies}\n`;
      }
      promptString += `Total Price: ‚Ç¨${totalPrice}\n`;

      // UI updates for loading state
      summariseOrderAIBtn.disabled = true;
      summariseOrderAIBtn.textContent = 'Generating...';
      orderSummaryOutput.textContent = 'Generating AI summary, please wait...';
      orderSummaryOutputContainer.style.display = 'block';

      try {
        const response = await fetch('https://gemini-api-worker.orierezori.workers.dev/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt: promptString }),
        });

        if (!response.ok) {
          const errorData = await response.text();
          throw new Error(`API request failed: ${response.status} ${response.statusText}. Response: ${errorData}`);
        }

        const result = await response.json();
        if (result && result.response) {
          // To make the Tikkie link part consistent, we can add it here as well or instruct the AI.
          // For now, just displaying AI response.
          // If the AI includes the "Tikkie link" phrase, the existing click listener for it might work.
          let aiSummary = result.response;
          // Check if the Tikkie placeholder needs to be added or if the AI handles it.
          // For now, assuming AI might generate a full message that could include it.
          // If we want to ensure the interactive Tikkie link:
          aiSummary += `\n\nTo confirm your order, please complete the payment via the Tikkie link below.\n`;
          aiSummary += `Once the payment is done, your order will be officially confirmed. If you have any questions, I'm here for you! üí¨\n\n`;
          aiSummary += `Looking forward to baking something special for you! üéÇüßÅ\n\n`;
          aiSummary += `Maayan (Manu) ü©∑\n`;
          aiSummary += `Payment Link:\n\n`;
          aiSummary += `<span class="tikkie-placeholder">[Tikkie link]</span>`;
          orderSummaryOutput.innerHTML = aiSummary; // Use innerHTML if adding span
        } else {
          orderSummaryOutput.textContent = 'Failed to get a valid summary from AI. Response structure might be incorrect.';
        }
      } catch (error) {
        console.error('Error calling AI summary API:', error);
        orderSummaryOutput.textContent = `Error generating AI summary: ${error.message}`;
      } finally {
        summariseOrderAIBtn.disabled = false;
        summariseOrderAIBtn.textContent = 'Summarise Order AI';
      }
    });
    // --- END OF ADDED EVENT LISTENER --- 

  </script>
</body>
</html>
